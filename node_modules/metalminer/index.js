(function () {
    var request = require('request'),
        cheerio = require('cheerio');

    module.exports.getMetalLyrics = function (metaInfo, callback) {
        var uri = "http://www.metal-archives.com/albums/" + metaInfo.artist.toLowerCase().replace(/ /gi, "_") + "/";
        uri += metaInfo.album.toLowerCase().replace(/ /gi, "_");
        request(uri, function (err, res, body) {
            if (err) {
                callback("Unknown error", null);
            }
            var found, $, trs, link, songId, href;
            $ = cheerio.load(body, { ignoreWhitespace: true });
            trs = $(".table_lyrics tr:not([id^=song])");
            if (trs.length === 0) {
                callback("Band is not metal enough!", null);
            }
            found = false;
            for (var i = 0; i < trs.length; i++) {
                element = trs[i];
                if ($(element).text().toLowerCase().indexOf(metaInfo.title.toLowerCase().replace(/^[0-9]{2,3} - /, "")) > -1) {
                    found = true;
                    link = $(element).find("a[id^=lyrics]");
                    if (!link || !link.attr("href") || link.attr("href").split("songId=").length < 2) {
                        callback("Found song, but no lyrics.", null);
                        return;
                    }
                    songId = link.attr("href").split("songId=")[1].split("#")[0];
                    href = "http://www.metal-archives.com/release/ajax-view-lyrics/id/" + songId;
                    request(href, function (err, res, body2) {
                        if (err) callback("Unknown error.");
                        callback(null, body2);
                        callback = null;
                    });
                }
                if (!found && i === trs.length - 1 && callback) {
                    callback("Found album, but not song.", null);
                }
            }
        });
    }
})();